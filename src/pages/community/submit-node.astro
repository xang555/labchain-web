---
import Layout from '../../layouts/Layout.astro';
import { createNodeRequest, isEndpointDuplicate } from '../../lib/data';

let message = '';
let messageType = '';
let submitted = false;

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();

  const nodeType = formData.get('node_type')?.toString() || '';
  const name = formData.get('name')?.toString() || '';
  const description = formData.get('description')?.toString() || '';
  const contactName = formData.get('contact_name')?.toString() || '';
  const contactEmail = formData.get('contact_email')?.toString() || '';

  // Handle different node types
  let endpoint = '';
  let enr = '';
  let p2p = '';

  if (nodeType === 'rpc') {
    endpoint = formData.get('endpoint')?.toString() || '';
  } else if (nodeType === 'bootnode') {
    endpoint = formData.get('enode')?.toString() || '';
  } else if (nodeType === 'beacon') {
    enr = formData.get('enr')?.toString() || '';
    p2p = formData.get('p2p')?.toString() || '';
    // For beacon nodes, use ENR as primary endpoint for storage
    endpoint = enr || p2p;
  }

  // Validate required fields
  if (!nodeType || !name || !contactEmail) {
    message = 'Please fill in all required fields.';
    messageType = 'error';
  } else if (nodeType === 'beacon' && !enr && !p2p) {
    message = 'For Beacon nodes, at least one of ENR or P2P (libp2p) must be provided.';
    messageType = 'error';
  } else if (nodeType !== 'beacon' && !endpoint) {
    message = 'Please provide the endpoint URL.';
    messageType = 'error';
  } else {
    // Check for duplicate endpoint
    const duplicate = isEndpointDuplicate(endpoint, nodeType);
    if (duplicate.exists) {
      message = `This endpoint already exists in ${duplicate.location}. Please use a different endpoint.`;
      messageType = 'error';
    } else {
      // Create the request - store ENR and P2P in description for beacon nodes
      const requestData = {
        node_type: nodeType,
        name,
        endpoint: nodeType === 'beacon' ? `ENR: ${enr}\nP2P: ${p2p}` : endpoint,
        description: nodeType === 'beacon' ? `${description}\n\nENR: ${enr}\nP2P: ${p2p}` : description,
        contact_name: contactName,
        contact_email: contactEmail
      };

      createNodeRequest(requestData);

      submitted = true;
      message = 'Your node request has been submitted successfully! We will review it and notify you via email.';
      messageType = 'success';
    }
  }
}
---

<Layout title="Submit Your Node - LAB Chain" description="Submit your RPC endpoint, boot node, or beacon node to be listed on the LAB Chain network.">
  <section class="page-hero">
    <div class="container">
      <div class="page-header">
        <div class="breadcrumb">
          <a href="/">Home</a>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
          <a href="/community">Community</a>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
          <span>Submit Node</span>
        </div>
        <h1>Submit Your Node</h1>
        <p>
          Share your RPC endpoint, boot node, or beacon node with the LAB Chain community.
          Once approved, your node will be listed on our public pages and you'll receive an email notification.
        </p>
      </div>
    </div>
  </section>

  <section class="form-section">
    <div class="container">
      {message && !submitted && (
        <div class={`alert alert-${messageType}`}>
          {message}
        </div>
      )}

      {!submitted ? (
        <div class="form-card">
          <form method="POST">
            <!-- Node Information Section -->
            <div class="form-section-title">
              <h2>Node Information</h2>
              <p>Provide details about the node you want to submit.</p>
            </div>

            <div class="form-group">
              <label class="form-label">Node Type *</label>
              <select name="node_type" class="form-select" required>
                <option value="">Select node type...</option>
                <option value="rpc">RPC Endpoint</option>
                <option value="bootnode">Boot Node</option>
                <option value="beacon">Beacon Node</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Node Name *</label>
              <input type="text" name="name" class="form-input" required placeholder="e.g., My LAB Chain Node" />
              <span class="form-hint">A friendly name for your node</span>
            </div>

            <!-- Fields for RPC -->
            <div class="form-group" id="rpc-endpoint-group" style="display: none;">
              <label class="form-label">Endpoint URL *</label>
              <textarea name="endpoint" class="form-textarea" placeholder="e.g., https://rpc.example.com"></textarea>
              <span class="form-hint">The HTTP(S) URL for your RPC endpoint</span>
            </div>

            <!-- Fields for Boot Node -->
            <div class="form-group" id="bootnode-endpoint-group" style="display: none;">
              <label class="form-label">
                Enode *
                <a href="/docs#bootnode-info" class="info-link" title="How to get Enode" target="_blank">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                  </svg>
                </a>
              </label>
              <textarea name="enode" class="form-textarea" placeholder="enode://...@host:port"></textarea>
              <span class="form-hint">The enode URL for peer discovery</span>
            </div>

            <!-- Fields for Beacon Node -->
            <div class="beacon-fields" id="beacon-fields" style="display: none;">
              <div class="form-group">
                <label class="form-label">
                  ENR (Ethereum Node Record)
                  <a href="/docs#bootnode-info" class="info-link" title="How to get ENR" target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                      <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                  </a>
                </label>
                <textarea name="enr" class="form-textarea" placeholder="enr:-..."></textarea>
                <span class="form-hint">The ENR string for peer discovery</span>
              </div>

              <div class="form-group">
                <label class="form-label">
                  P2P (libp2p Address)
                  <a href="/docs#bootnode-info" class="info-link" title="How to get libp2p address" target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                      <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                  </a>
                </label>
                <textarea name="p2p" class="form-textarea" placeholder="/ip4/... or /dns4/..."></textarea>
                <span class="form-hint">The libp2p multiaddress for direct P2P connection</span>
              </div>

              <div class="form-notice">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <span>At least one of ENR or P2P must be provided</span>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea name="description" class="form-textarea" rows="3" placeholder="Tell us more about your node (optional)"></textarea>
            </div>

            <!-- Contact Information Section -->
            <div class="form-section-title" style="margin-top: 40px; padding-top: 32px; border-top: 1px solid var(--border-color);">
              <h2>Contact Information</h2>
              <p>We'll use this to notify you about your submission status.</p>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Your Name</label>
                <input type="text" name="contact_name" class="form-input" placeholder="e.g., John Doe" />
              </div>

              <div class="form-group">
                <label class="form-label">Email Address *</label>
                <input type="email" name="contact_email" class="form-input" required placeholder="e.g., you@example.com" />
                <span class="form-hint">Required for status notifications</span>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary btn-lg">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
                Submit Request
              </button>
            </div>
          </form>
        </div>
      ) : (
        <div class="success-card">
          <div class="success-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          <h2>Request Submitted!</h2>
          <p>Your node request has been received and is pending review. We will notify you via email once your submission has been reviewed.</p>
          <div class="success-info">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            <span>Check your email for updates on your submission.</span>
          </div>
          <div class="success-actions">
            <a href="/community/submit-node" class="btn btn-primary">Submit Another</a>
            <a href="/community" class="btn btn-secondary">Back to Community</a>
          </div>
        </div>
      )}
    </div>
  </section>

  <section class="info-section">
    <div class="container">
      <div class="info-grid">
        <div class="info-card">
          <div class="info-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
          </div>
          <h3>Review Process</h3>
          <p>All submissions are reviewed by our team to ensure quality and security.</p>
        </div>
        <div class="info-card">
          <div class="info-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
          </div>
          <h3>Email Notifications</h3>
          <p>You'll receive an email when your submission is approved or if we need more information.</p>
        </div>
        <div class="info-card">
          <div class="info-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
          </div>
          <h3>Processing Time</h3>
          <p>Most requests are reviewed within 24-48 hours.</p>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  .page-hero {
    padding: 48px 0 32px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
  }

  .page-header {
    max-width: 700px;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--text-tertiary);
    margin-bottom: 16px;
  }

  .breadcrumb a {
    color: var(--text-secondary);
    transition: color var(--transition-fast);
  }

  .breadcrumb a:hover {
    color: var(--color-red);
  }

  .page-header h1 {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    margin-bottom: 16px;
  }

  .page-header p {
    font-size: 16px;
    color: var(--text-secondary);
    line-height: 1.7;
  }

  .form-section {
    padding: 48px 0 80px;
  }

  .alert {
    max-width: 700px;
    margin: 0 auto 24px;
    padding: 16px 20px;
    border-radius: var(--radius-lg);
  }

  .alert-success {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    color: #22C55E;
  }

  .alert-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #EF4444;
  }

  .form-card {
    max-width: 700px;
    margin: 0 auto;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: 40px;
  }

  .form-section-title {
    margin-bottom: 24px;
  }

  .form-section-title h2 {
    font-size: 18px;
    margin-bottom: 4px;
  }

  .form-section-title p {
    font-size: 14px;
    color: var(--text-secondary);
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }

  .form-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .info-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--text-tertiary);
    transition: color var(--transition-fast);
  }

  .info-link:hover {
    color: var(--color-red);
  }

  .form-input,
  .form-select,
  .form-textarea {
    width: 100%;
    padding: 12px 16px;
    font-size: 14px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-primary);
    color: var(--text-primary);
    transition: all var(--transition-fast);
  }

  .form-input:focus,
  .form-select:focus,
  .form-textarea:focus {
    outline: none;
    border-color: var(--color-red);
    box-shadow: 0 0 0 3px rgba(206, 17, 38, 0.1);
  }

  .form-textarea {
    min-height: 100px;
    resize: vertical;
  }

  .form-hint {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    color: var(--text-tertiary);
  }

  .form-actions {
    margin-top: 32px;
  }

  .btn-lg {
    padding: 14px 28px;
    font-size: 16px;
  }

  .btn-lg svg {
    margin-right: 8px;
  }

  .success-card {
    max-width: 500px;
    margin: 0 auto;
    text-align: center;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    padding: 48px 40px;
  }

  .success-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
    background: rgba(34, 197, 94, 0.1);
    color: #22C55E;
    border-radius: 50%;
    margin-bottom: 24px;
  }

  .success-card h2 {
    font-size: 24px;
    margin-bottom: 8px;
  }

  .success-card > p {
    color: var(--text-secondary);
    margin-bottom: 24px;
    line-height: 1.7;
  }

  .success-info {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 16px 20px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: var(--radius-lg);
    color: #3B82F6;
    font-size: 14px;
    margin-bottom: 24px;
  }

  .success-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .info-section {
    padding: 0 0 80px;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
  }

  .info-card {
    padding: 24px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
  }

  .info-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: rgba(206, 17, 38, 0.1);
    color: var(--color-red);
    border-radius: var(--radius-md);
    margin-bottom: 16px;
  }

  .info-card h3 {
    font-size: 16px;
    margin-bottom: 8px;
  }

  .info-card p {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.6;
  }

  .form-notice {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: var(--radius-md);
    color: #3B82F6;
    font-size: 13px;
    margin-bottom: 20px;
  }

  .beacon-fields {
    animation: fadeIn 0.2s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    .form-card {
      padding: 24px;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .info-grid {
      grid-template-columns: 1fr;
    }

    .success-actions {
      flex-direction: column;
    }
  }
</style>

<script>
  const nodeTypeSelect = document.querySelector('select[name="node_type"]');
  const rpcEndpointGroup = document.getElementById('rpc-endpoint-group');
  const bootnodeEndpointGroup = document.getElementById('bootnode-endpoint-group');
  const beaconFields = document.getElementById('beacon-fields');
  const endpointTextarea = document.querySelector('textarea[name="endpoint"]');
  const enodeTextarea = document.querySelector('textarea[name="enode"]');

  function toggleFields() {
    const selectedType = nodeTypeSelect?.value;

    // Hide all fields first
    if (rpcEndpointGroup) rpcEndpointGroup.style.display = 'none';
    if (bootnodeEndpointGroup) bootnodeEndpointGroup.style.display = 'none';
    if (beaconFields) beaconFields.style.display = 'none';

    // Remove required from all
    if (endpointTextarea) endpointTextarea.removeAttribute('required');
    if (enodeTextarea) enodeTextarea.removeAttribute('required');

    // Show appropriate fields based on selection
    if (selectedType === 'rpc') {
      if (rpcEndpointGroup) rpcEndpointGroup.style.display = 'block';
      if (endpointTextarea) endpointTextarea.setAttribute('required', '');
    } else if (selectedType === 'bootnode') {
      if (bootnodeEndpointGroup) bootnodeEndpointGroup.style.display = 'block';
      if (enodeTextarea) enodeTextarea.setAttribute('required', '');
    } else if (selectedType === 'beacon') {
      if (beaconFields) beaconFields.style.display = 'block';
    }
  }

  nodeTypeSelect?.addEventListener('change', toggleFields);
  toggleFields();
</script>
