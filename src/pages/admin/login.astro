---
import { isFirstTimeSetup, createUser, authenticateUser, createSession, validateSessionCookie } from '../../lib/auth';

// Check if already logged in
const user = validateSessionCookie(Astro.request.headers.get('cookie') ?? undefined);
if (user) {
  return Astro.redirect('/admin');
}

const isSetup = isFirstTimeSetup();
let error = '';
let success = '';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const username = formData.get('username')?.toString() || '';
    const password = formData.get('password')?.toString() || '';
    const confirmPassword = formData.get('confirmPassword')?.toString() || '';

    if (isSetup) {
      // First-time setup - create admin user
      if (!username || !password || !confirmPassword) {
        error = 'All fields are required';
      } else if (password !== confirmPassword) {
        error = 'Passwords do not match';
      } else if (password.length < 6) {
        error = 'Password must be at least 6 characters';
      } else {
        const newUser = createUser(username, password);
        if (newUser) {
          const sessionId = createSession(newUser.id);
          const response = Astro.redirect('/admin');
          response.headers.set('Set-Cookie', `session=${sessionId}; Path=/; HttpOnly; SameSite=Strict; Max-Age=${7 * 24 * 60 * 60}`);
          return response;
        } else {
          error = 'Failed to create user';
        }
      }
    } else {
      // Login existing user
      if (!username || !password) {
        error = 'Username and password are required';
      } else {
        const authUser = authenticateUser(username, password);
        if (authUser) {
          const sessionId = createSession(authUser.id);
          const response = Astro.redirect('/admin');
          response.headers.set('Set-Cookie', `session=${sessionId}; Path=/; HttpOnly; SameSite=Strict; Max-Age=${7 * 24 * 60 * 60}`);
          return response;
        } else {
          error = 'Invalid username or password';
        }
      }
    }
  } catch (e) {
    error = 'An error occurred. Please try again.';
    console.error(e);
  }
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{isSetup ? 'Setup Admin' : 'Admin Login'} - LAB Chain</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    :root {
      --color-primary: rgb(20 137 213);
      --color-primary-dark: rgb(14 105 168);
      --color-white: #FFFFFF;
      --bg-primary: #0F172A;
      --bg-secondary: #1E293B;
      --bg-card: #1E293B;
      --bg-tertiary: #334155;
      --text-primary: #F8FAFC;
      --text-secondary: #CBD5E1;
      --text-tertiary: #94A3B8;
      --border-color: #334155;
      --shadow-primary: 0 4px 14px -3px rgba(20, 137, 213, 0.35);
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .login-container {
      width: 100%;
      max-width: 420px;
    }

    .login-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      padding: 40px;
    }

    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 24px;
    }

    .logo svg {
      width: 64px;
      height: 64px;
    }

    h1 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 8px;
    }

    .subtitle {
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 32px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    input {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: var(--color-primary);
    }

    input::placeholder {
      color: var(--text-tertiary);
    }

    .btn {
      width: 100%;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      font-size: 14px;
      margin-bottom: 20px;
    }

    .success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      font-size: 14px;
      margin-bottom: 20px;
    }

    .setup-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 16px;
      width: 100%;
    }

    .back-link {
      display: block;
      text-align: center;
      margin-top: 24px;
      color: var(--text-secondary);
      font-size: 14px;
      text-decoration: none;
    }

    .back-link:hover {
      color: var(--color-primary);
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="logo">
        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="rgb(20, 137, 213)"/>
              <stop offset="50%" stop-color="#FFFFFF"/>
              <stop offset="100%" stop-color="rgb(16, 110, 170)"/>
            </linearGradient>
          </defs>
          <circle cx="50" cy="50" r="45" stroke="url(#logoGradient)" stroke-width="4" fill="none"/>
          <path d="M30 50 L45 35 L45 45 L70 45 L70 55 L45 55 L45 65 Z" fill="rgb(20, 137, 213)"/>
          <circle cx="50" cy="50" r="8" fill="rgb(16, 110, 170)"/>
        </svg>
      </div>

      {isSetup && (
        <div class="setup-badge">First Time Setup</div>
      )}

      <h1>{isSetup ? 'Create Admin Account' : 'Admin Login'}</h1>
      <p class="subtitle">
        {isSetup
          ? 'Set up your admin credentials to manage LAB Chain data'
          : 'Sign in to access the admin panel'}
      </p>

      {error && <div class="error">{error}</div>}
      {success && <div class="success">{success}</div>}

      <form method="POST">
        <div class="form-group">
          <label for="username">Username</label>
          <input
            type="text"
            id="username"
            name="username"
            placeholder="Enter username"
            required
            autocomplete="username"
          />
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="Enter password"
            required
            autocomplete={isSetup ? 'new-password' : 'current-password'}
            minlength={isSetup ? 6 : undefined}
          />
        </div>

        {isSetup && (
          <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              placeholder="Confirm password"
              required
              autocomplete="new-password"
              minlength="6"
            />
          </div>
        )}

        <button type="submit" class="btn">
          {isSetup ? 'Create Account' : 'Sign In'}
        </button>
      </form>

      <a href="/" class="back-link">Back to Home</a>
    </div>
  </div>
</body>
</html>
