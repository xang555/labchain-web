---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getAllNodeRequests, getNodeRequestById, updateNodeRequestStatus, deleteNodeRequest, approveAndCreateNode } from '../../lib/data';
import { validateSessionCookie } from '../../lib/auth';
import { sendApprovalEmail, sendRejectionEmail, isEmailConfigured } from '../../lib/email';

// Check authentication
const user = validateSessionCookie(Astro.request.headers.get('cookie') ?? undefined);
if (!user) {
  return Astro.redirect('/admin/login');
}

let message = '';
let messageType = '';

// Handle form submissions
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action')?.toString();
  const id = parseInt(formData.get('id')?.toString() || '0');

  if (action === 'approve') {
    const request = getNodeRequestById(id);
    const result = approveAndCreateNode(id);
    if (result.success) {
      message = 'Request approved and node created successfully';
      messageType = 'success';

      // Send approval email
      if (request && request.contact_email && isEmailConfigured()) {
        const emailResult = await sendApprovalEmail(request);
        if (emailResult.success) {
          message += '. Notification email sent.';
        } else {
          message += `. Email notification failed: ${emailResult.error}`;
        }
      }
    } else {
      message = `Failed to approve: ${result.error}`;
      messageType = 'error';
    }
  } else if (action === 'reject') {
    const adminNotes = formData.get('admin_notes')?.toString() || '';
    const request = getNodeRequestById(id);
    updateNodeRequestStatus(id, 'rejected', adminNotes);
    message = 'Request rejected';
    messageType = 'success';

    // Send rejection email
    if (request && request.contact_email && isEmailConfigured()) {
      const emailResult = await sendRejectionEmail(request, adminNotes);
      if (emailResult.success) {
        message += '. Notification email sent.';
      } else {
        message += `. Email notification failed: ${emailResult.error}`;
      }
    }
  } else if (action === 'delete') {
    deleteNodeRequest(id);
    message = 'Request deleted successfully';
    messageType = 'success';
  } else if (action === 'pending') {
    updateNodeRequestStatus(id, 'pending');
    message = 'Request moved back to pending';
    messageType = 'success';
  }
}

const requests = getAllNodeRequests();
const urlParams = new URL(Astro.request.url).searchParams;
const filterStatus = urlParams.get('status') || 'all';
const viewId = urlParams.get('view') ? parseInt(urlParams.get('view')!) : null;
const viewItem = viewId ? getNodeRequestById(viewId) : null;

const filteredRequests = filterStatus === 'all'
  ? requests
  : requests.filter(r => r.status === filterStatus);

const pendingCount = requests.filter(r => r.status === 'pending').length;
const approvedCount = requests.filter(r => r.status === 'approved').length;
const rejectedCount = requests.filter(r => r.status === 'rejected').length;

const nodeTypeLabels: Record<string, string> = {
  rpc: 'RPC Endpoint',
  bootnode: 'Boot Node',
  beacon: 'Beacon Node'
};

const emailConfigured = isEmailConfigured();
---

<AdminLayout title="Share Node Requests" currentPage="requests" user={user}>
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1 class="page-title">Share Node Requests</h1>
        <p class="page-subtitle">Review and manage community node submissions</p>
      </div>
      <div class="email-status">
        {emailConfigured ? (
          <span class="email-badge configured">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Email notifications enabled
          </span>
        ) : (
          <a href="/admin/settings" class="email-badge not-configured">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            Configure email notifications
          </a>
        )}
      </div>
    </div>
  </div>

  {message && (
    <div class={`alert alert-${messageType}`}>{message}</div>
  )}

  <!-- Desktop: Stats Row -->
  <div class="stats-row desktop-filter">
    <a href="/admin/requests" class={`stat-chip ${filterStatus === 'all' ? 'active' : ''}`}>
      <span class="stat-count">{requests.length}</span>
      <span class="stat-label">All</span>
    </a>
    <a href="/admin/requests?status=pending" class={`stat-chip pending ${filterStatus === 'pending' ? 'active' : ''}`}>
      <span class="stat-count">{pendingCount}</span>
      <span class="stat-label">Pending</span>
    </a>
    <a href="/admin/requests?status=approved" class={`stat-chip approved ${filterStatus === 'approved' ? 'active' : ''}`}>
      <span class="stat-count">{approvedCount}</span>
      <span class="stat-label">Approved</span>
    </a>
    <a href="/admin/requests?status=rejected" class={`stat-chip rejected ${filterStatus === 'rejected' ? 'active' : ''}`}>
      <span class="stat-count">{rejectedCount}</span>
      <span class="stat-label">Rejected</span>
    </a>
  </div>

  <!-- Mobile: Custom Dropdown Filter -->
  <div class="mobile-filter">
    <div class="custom-dropdown" id="statusDropdown">
      <button type="button" class="dropdown-trigger" id="dropdownTrigger">
        <div class="dropdown-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
        </div>
        <div class="dropdown-content">
          <span class="dropdown-label">Filter by status</span>
          <span class="dropdown-value" id="dropdownValue">
            {filterStatus === 'all' && `All Requests (${requests.length})`}
            {filterStatus === 'pending' && `Pending (${pendingCount})`}
            {filterStatus === 'approved' && `Approved (${approvedCount})`}
            {filterStatus === 'rejected' && `Rejected (${rejectedCount})`}
          </span>
        </div>
        <div class="dropdown-chevron">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
      </button>
      <div class="dropdown-menu" id="dropdownMenu">
        <a href="/admin/requests" class={`dropdown-item ${filterStatus === 'all' ? 'active' : ''}`}>
          <span class="item-dot"></span>
          <span class="item-text">All Requests</span>
          <span class="item-count">{requests.length}</span>
        </a>
        <a href="/admin/requests?status=pending" class={`dropdown-item pending ${filterStatus === 'pending' ? 'active' : ''}`}>
          <span class="item-dot"></span>
          <span class="item-text">Pending</span>
          <span class="item-count">{pendingCount}</span>
        </a>
        <a href="/admin/requests?status=approved" class={`dropdown-item approved ${filterStatus === 'approved' ? 'active' : ''}`}>
          <span class="item-dot"></span>
          <span class="item-text">Approved</span>
          <span class="item-count">{approvedCount}</span>
        </a>
        <a href="/admin/requests?status=rejected" class={`dropdown-item rejected ${filterStatus === 'rejected' ? 'active' : ''}`}>
          <span class="item-dot"></span>
          <span class="item-text">Rejected</span>
          <span class="item-count">{rejectedCount}</span>
        </a>
      </div>
    </div>
  </div>

  {filteredRequests.length === 0 ? (
    <div class="card">
      <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="12" y1="18" x2="12" y2="12"></line>
          <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>
        <h3>No Requests</h3>
        <p>{filterStatus === 'all' ? 'No node requests have been submitted yet.' : `No ${filterStatus} requests.`}</p>
      </div>
    </div>
  ) : (
    <>
      <!-- Desktop Table View -->
      <div class="card desktop-view">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Tracking ID</th>
                <th>Type</th>
                <th>Name</th>
                <th>Contact</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {filteredRequests.map((req) => (
                <tr>
                  <td>
                    <code class="tracking-code">{req.tracking_id}</code>
                  </td>
                  <td>
                    <span class={`type-badge ${req.node_type}`}>{nodeTypeLabels[req.node_type] || req.node_type}</span>
                  </td>
                  <td>
                    <strong>{req.name}</strong>
                    <div class="endpoint-preview" title={req.endpoint}>
                      {req.endpoint.length > 30 ? req.endpoint.substring(0, 30) + '...' : req.endpoint}
                    </div>
                  </td>
                  <td>
                    <div class="contact-info">
                      {req.contact_name && <span class="contact-name">{req.contact_name}</span>}
                      <a href={`mailto:${req.contact_email}`} class="contact-email">{req.contact_email}</a>
                    </div>
                  </td>
                  <td>
                    <span class={`status-badge ${req.status}`}>{req.status}</span>
                  </td>
                  <td>
                    <span class="date-text">{new Date(req.created_at).toLocaleDateString()}</span>
                  </td>
                  <td>
                    <div class="actions-cell">
                      <a href={`/admin/requests?view=${req.id}`} class="action-icon" title="View Details">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                          <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                      </a>
                      {req.status === 'pending' && (
                        <>
                          <form method="POST" class="inline-form">
                            <input type="hidden" name="action" value="approve" />
                            <input type="hidden" name="id" value={req.id} />
                            <button type="submit" class="action-icon approve" title="Approve">
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                              </svg>
                            </button>
                          </form>
                          <a href={`/admin/requests?view=${req.id}&reject=1`} class="action-icon reject" title="Reject">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <line x1="18" y1="6" x2="6" y2="18"></line>
                              <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                          </a>
                        </>
                      )}
                      <form method="POST" class="inline-form" onsubmit="return confirm('Are you sure you want to delete this request?')">
                        <input type="hidden" name="action" value="delete" />
                        <input type="hidden" name="id" value={req.id} />
                        <button type="submit" class="action-icon delete" title="Delete">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                          </svg>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mobile Card View -->
      <div class="mobile-cards">
        {filteredRequests.map((req) => (
          <div class="request-card">
            <div class="card-header">
              <div class="card-header-left">
                <span class={`type-badge ${req.node_type}`}>{nodeTypeLabels[req.node_type] || req.node_type}</span>
                <span class={`status-badge ${req.status}`}>{req.status}</span>
              </div>
              <span class="card-date">{new Date(req.created_at).toLocaleDateString()}</span>
            </div>

            <div class="card-body">
              <div class="card-title-row">
                <div class="card-name">{req.name}</div>
                <code class="tracking-code-small">{req.tracking_id}</code>
              </div>

              <div class="card-endpoint">
                <span class="card-endpoint-label">Endpoint</span>
                <code class="card-endpoint-value">{req.endpoint.length > 40 ? req.endpoint.substring(0, 40) + '...' : req.endpoint}</code>
              </div>

              <div class="card-contact">
                {req.contact_name && <span class="card-contact-name">{req.contact_name}</span>}
                <a href={`mailto:${req.contact_email}`} class="card-contact-email">{req.contact_email}</a>
              </div>
            </div>

            <div class="card-actions">
              <a href={`/admin/requests?view=${req.id}`} class="card-action-btn view">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                View
              </a>
              {req.status === 'pending' && (
                <>
                  <form method="POST" class="card-approve-form">
                    <input type="hidden" name="action" value="approve" />
                    <input type="hidden" name="id" value={req.id} />
                    <button type="submit" class="card-action-btn approve">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                      Approve
                    </button>
                  </form>
                  <a href={`/admin/requests?view=${req.id}&reject=1`} class="card-action-btn reject">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Reject
                  </a>
                </>
              )}
              <form method="POST" class="card-delete-form" onsubmit="return confirm('Are you sure you want to delete this request?')">
                <input type="hidden" name="action" value="delete" />
                <input type="hidden" name="id" value={req.id} />
                <button type="submit" class="card-action-btn delete">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                  Delete
                </button>
              </form>
            </div>
          </div>
        ))}
      </div>
    </>
  )}

  <!-- View/Reject Modal -->
  <div class={`modal-overlay ${viewItem ? 'open' : ''}`} id="modal">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2 class="modal-title">Request Details</h2>
        <a href={`/admin/requests${filterStatus !== 'all' ? `?status=${filterStatus}` : ''}`} class="modal-close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </a>
      </div>
      {viewItem && (
        <div class="modal-body">
          <div class="detail-header">
            <div class="detail-title">
              <h3>{viewItem.name}</h3>
              <span class={`status-badge ${viewItem.status}`}>{viewItem.status}</span>
            </div>
            <div class="detail-meta">
              <span class="tracking-code">{viewItem.tracking_id}</span>
              <span class={`type-badge ${viewItem.node_type}`}>{nodeTypeLabels[viewItem.node_type]}</span>
            </div>
          </div>

          <div class="detail-grid">
            <div class="detail-item full-width">
              <span class="detail-label">Endpoint</span>
              <code class="detail-code">{viewItem.endpoint}</code>
            </div>
            {viewItem.location && (
              <div class="detail-item">
                <span class="detail-label">Location</span>
                <span class="detail-value">{viewItem.location}</span>
              </div>
            )}
            <div class="detail-item">
              <span class="detail-label">Submitted</span>
              <span class="detail-value">{new Date(viewItem.created_at).toLocaleString()}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Contact Name</span>
              <span class="detail-value">{viewItem.contact_name || '-'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Contact Email</span>
              <a href={`mailto:${viewItem.contact_email}`} class="detail-value link">{viewItem.contact_email}</a>
            </div>
            {viewItem.description && (
              <div class="detail-item full-width">
                <span class="detail-label">Description</span>
                <span class="detail-value">{viewItem.description}</span>
              </div>
            )}
            {viewItem.admin_notes && (
              <div class="detail-item full-width">
                <span class="detail-label">Admin Notes</span>
                <span class="detail-value">{viewItem.admin_notes}</span>
              </div>
            )}
          </div>

          {urlParams.get('reject') === '1' && viewItem.status === 'pending' && (
            <form method="POST" class="reject-form">
              <input type="hidden" name="action" value="reject" />
              <input type="hidden" name="id" value={viewItem.id} />
              <div class="reject-form-header">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <span>Reject Request</span>
              </div>
              <div class="form-group">
                <label class="form-label">Rejection Reason *</label>
                <textarea name="admin_notes" class="form-textarea" rows="4" required placeholder="Please provide a reason for rejecting this request. This will be visible to the user when they check their request status."></textarea>
                <span class="form-hint">This reason will be displayed to the user on the request status page.</span>
              </div>
              <div class="form-actions">
                <a href={`/admin/requests?view=${viewItem.id}`} class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-danger">Reject Request</button>
              </div>
            </form>
          )}
        </div>
      )}
      {viewItem && urlParams.get('reject') !== '1' && (
        <div class="modal-footer">
          {viewItem.status === 'pending' && (
            <>
              <form method="POST" class="inline-form">
                <input type="hidden" name="action" value="approve" />
                <input type="hidden" name="id" value={viewItem.id} />
                <button type="submit" class="btn btn-success">Approve & Create Node</button>
              </form>
              <a href={`/admin/requests?view=${viewItem.id}&reject=1`} class="btn btn-danger">Reject</a>
            </>
          )}
          {viewItem.status === 'rejected' && (
            <form method="POST" class="inline-form">
              <input type="hidden" name="action" value="pending" />
              <input type="hidden" name="id" value={viewItem.id} />
              <button type="submit" class="btn btn-secondary">Move to Pending</button>
            </form>
          )}
          <a href={`/admin/requests${filterStatus !== 'all' ? `?status=${filterStatus}` : ''}`} class="btn btn-secondary">Close</a>
        </div>
      )}
    </div>
  </div>
</AdminLayout>

<style>
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .email-status {
    margin-top: 4px;
  }

  .email-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    border-radius: var(--radius-md);
  }

  .email-badge.configured {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.3);
  }

  .email-badge.not-configured {
    background: rgba(234, 179, 8, 0.1);
    color: #eab308;
    border: 1px solid rgba(234, 179, 8, 0.3);
    transition: all var(--transition-fast);
  }

  .email-badge.not-configured:hover {
    background: rgba(234, 179, 8, 0.2);
  }

  .stats-row {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
  }

  /* Mobile filter dropdown */
  .mobile-filter {
    display: none;
    margin-bottom: 20px;
  }

  .custom-dropdown {
    position: relative;
  }

  .dropdown-trigger {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .dropdown-trigger:hover {
    border-color: var(--border-color-strong);
  }

  .dropdown-trigger.open {
    border-color: var(--color-primary);
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  }

  .dropdown-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    flex-shrink: 0;
  }

  .dropdown-content {
    flex: 1;
    min-width: 0;
    text-align: left;
  }

  .dropdown-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 4px;
  }

  .dropdown-value {
    display: block;
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .dropdown-chevron {
    color: var(--text-tertiary);
    flex-shrink: 0;
    transition: transform var(--transition-fast);
  }

  .dropdown-trigger.open .dropdown-chevron {
    transform: rotate(180deg);
  }

  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg-card);
    border: 1px solid var(--color-primary);
    border-top: none;
    border-bottom-left-radius: var(--radius-lg);
    border-bottom-right-radius: var(--radius-lg);
    padding: 8px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all var(--transition-fast);
    z-index: 100;
  }

  .dropdown-menu.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .dropdown-item:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .dropdown-item.active {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .item-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--text-tertiary);
    flex-shrink: 0;
  }

  .dropdown-item.active .item-dot {
    background: var(--color-primary);
  }

  .dropdown-item.pending .item-dot {
    background: #EAB308;
  }

  .dropdown-item.approved .item-dot {
    background: #22C55E;
  }

  .dropdown-item.rejected .item-dot {
    background: #EF4444;
  }

  .item-text {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
  }

  .item-count {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-tertiary);
    background: var(--bg-secondary);
    padding: 2px 8px;
    border-radius: 10px;
  }

  .dropdown-item.active .item-count {
    background: var(--color-primary);
    color: white;
  }

  .stat-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .stat-chip:hover {
    border-color: var(--border-color-strong);
  }

  .stat-chip.active {
    border-color: var(--color-primary);
    background: rgba(20, 137, 213, 0.05);
  }

  .stat-chip.pending.active {
    border-color: #EAB308;
    background: rgba(234, 179, 8, 0.05);
  }

  .stat-chip.approved.active {
    border-color: #22C55E;
    background: rgba(34, 197, 94, 0.05);
  }

  .stat-chip.rejected.active {
    border-color: #EF4444;
    background: rgba(239, 68, 68, 0.05);
  }

  .stat-count {
    font-size: 18px;
    font-weight: 700;
  }

  .stat-chip.pending .stat-count { color: #EAB308; }
  .stat-chip.approved .stat-count { color: #22C55E; }
  .stat-chip.rejected .stat-count { color: #EF4444; }

  .stat-label {
    font-size: 13px;
    color: var(--text-secondary);
  }

  .tracking-code {
    font-size: 12px;
    font-weight: 600;
    color: var(--color-primary);
    background: rgba(20, 137, 213, 0.1);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
  }

  .type-badge {
    display: inline-block;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .type-badge.rpc {
    background: rgba(59, 130, 246, 0.1);
    color: #3B82F6;
  }

  .type-badge.bootnode {
    background: rgba(168, 85, 247, 0.1);
    color: #A855F7;
  }

  .type-badge.beacon {
    background: rgba(34, 197, 94, 0.1);
    color: #22C55E;
  }

  .endpoint-preview {
    font-size: 11px;
    color: var(--text-tertiary);
    font-family: monospace;
    margin-top: 4px;
  }

  .contact-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .contact-name {
    font-size: 13px;
    color: var(--text-primary);
  }

  .contact-email {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .contact-email:hover {
    color: var(--color-primary);
  }

  .status-badge {
    display: inline-block;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .status-badge.pending {
    background: rgba(234, 179, 8, 0.15);
    color: #EAB308;
  }

  .status-badge.approved {
    background: rgba(34, 197, 94, 0.15);
    color: #22C55E;
  }

  .status-badge.rejected {
    background: rgba(239, 68, 68, 0.15);
    color: #EF4444;
  }

  .date-text {
    font-size: 13px;
    color: var(--text-secondary);
  }

  .inline-form {
    display: inline;
  }

  .action-icon.approve {
    color: #22C55E;
  }

  .action-icon.approve:hover {
    background: rgba(34, 197, 94, 0.1);
  }

  .action-icon.reject {
    color: #EF4444;
  }

  .action-icon.reject:hover {
    background: rgba(239, 68, 68, 0.1);
  }

  .modal-lg {
    max-width: 700px;
  }

  .detail-header {
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
  }

  .detail-title {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .detail-title h3 {
    font-size: 20px;
    margin: 0;
  }

  .detail-meta {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .detail-item.full-width {
    grid-column: 1 / -1;
  }

  .detail-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .detail-value {
    font-size: 14px;
    color: var(--text-primary);
  }

  .detail-value.link {
    color: var(--color-primary);
  }

  .detail-code {
    display: block;
    padding: 12px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    font-size: 13px;
    word-break: break-all;
  }

  .reject-form {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border-color);
  }

  .reject-form-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    color: #EF4444;
    font-size: 16px;
    font-weight: 600;
  }

  .form-hint {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    color: var(--text-tertiary);
  }

  .form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 16px;
  }

  .btn-success {
    background: #22C55E;
    color: white;
  }

  .btn-success:hover {
    background: #16A34A;
  }

  .btn-danger {
    background: #EF4444;
    color: white;
  }

  .btn-danger:hover {
    background: #DC2626;
  }

  /* Table scrollable inside card */
  .card {
    overflow: hidden;
  }

  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .table-container table {
    min-width: 700px;
  }

  /* Mobile Cards */
  .mobile-cards {
    display: none;
  }

  .request-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    margin-bottom: 12px;
    overflow: hidden;
  }

  .request-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    gap: 12px;
  }

  .card-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    min-width: 0;
  }

  .card-date {
    font-size: 12px;
    color: var(--text-tertiary);
    flex-shrink: 0;
  }

  .card-body {
    padding: 16px;
  }

  .card-title-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 12px;
  }

  .card-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .tracking-code-small {
    font-size: 10px;
    font-weight: 600;
    color: var(--color-primary);
    background: rgba(20, 137, 213, 0.1);
    padding: 3px 6px;
    border-radius: var(--radius-sm);
    flex-shrink: 0;
  }

  .card-endpoint {
    margin-bottom: 12px;
  }

  .card-endpoint-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 4px;
  }

  .card-endpoint-value {
    display: block;
    font-size: 12px;
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    padding: 8px 10px;
    border-radius: var(--radius-sm);
    word-break: break-all;
  }

  .card-contact {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .card-contact-name {
    font-size: 13px;
    color: var(--text-primary);
    font-weight: 500;
  }

  .card-contact-email {
    font-size: 13px;
    color: var(--text-secondary);
    word-break: break-all;
  }

  .card-contact-email:hover {
    color: var(--color-primary);
  }

  .card-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
  }

  .card-action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 500;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    background: var(--bg-card);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    flex: 1;
    min-width: 0;
  }

  .card-action-btn:hover {
    border-color: var(--border-color-strong);
    color: var(--text-primary);
  }

  .card-action-btn.view:hover {
    border-color: var(--color-blue);
    color: var(--color-blue);
  }

  .card-action-btn.approve {
    border-color: #22C55E;
    color: #22C55E;
  }

  .card-action-btn.approve:hover {
    background: rgba(34, 197, 94, 0.1);
  }

  .card-action-btn.reject {
    border-color: #EF4444;
    color: #EF4444;
  }

  .card-action-btn.reject:hover {
    background: rgba(239, 68, 68, 0.1);
  }

  .card-action-btn.delete {
    border-color: var(--text-tertiary);
    color: var(--text-tertiary);
  }

  .card-action-btn.delete:hover {
    border-color: #EF4444;
    color: #EF4444;
    background: rgba(239, 68, 68, 0.1);
  }

  .card-approve-form,
  .card-delete-form {
    display: contents;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .desktop-view {
      display: none;
    }

    .mobile-cards {
      display: block;
    }
  }

  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      gap: 12px;
    }

    .email-badge {
      font-size: 11px;
      padding: 5px 10px;
    }

    /* Hide desktop filter, show mobile dropdown */
    .desktop-filter {
      display: none;
    }

    .mobile-filter {
      display: block;
    }

    .detail-grid {
      grid-template-columns: 1fr;
    }

    .modal-lg {
      max-width: calc(100% - 24px);
      max-height: calc(100vh - 48px);
    }

    .modal-body {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .modal-footer {
      flex-wrap: wrap;
    }

    .modal-footer .btn {
      flex: 1;
      min-width: calc(50% - 6px);
    }

    .card-actions {
      flex-wrap: wrap;
    }

    .card-action-btn {
      flex: 1 1 calc(50% - 4px);
      min-width: calc(50% - 4px);
    }
  }

  @media (max-width: 480px) {
    .page-header {
      padding-bottom: 16px;
    }

    .detail-header {
      margin-bottom: 16px;
      padding-bottom: 12px;
    }

    .detail-title {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .detail-title h3 {
      font-size: 18px;
    }

    .detail-meta {
      flex-wrap: wrap;
    }

    .detail-grid {
      gap: 16px;
    }

    .detail-code {
      font-size: 11px;
      padding: 10px;
    }

    .form-actions {
      flex-direction: column;
    }

    .form-actions .btn {
      width: 100%;
    }

    .modal-footer {
      flex-direction: column;
      gap: 8px;
    }

    .modal-footer .btn {
      width: 100%;
    }

    .card-title-row {
      flex-direction: column;
      gap: 8px;
    }

    .card-action-btn {
      flex: 1 1 100%;
      min-width: 100%;
    }

    .modal-lg {
      max-width: calc(100% - 16px);
      margin: 8px;
    }

    .modal-header {
      padding: 16px;
    }

    .modal-body {
      padding: 16px;
    }

    .modal-footer {
      padding: 16px;
    }
  }
</style>

<script>
  // Modal close handlers
  const modal = document.getElementById('modal');
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      const url = new URL(window.location.href);
      const status = url.searchParams.get('status');
      window.location.href = '/admin/requests' + (status ? `?status=${status}` : '');
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      // Close modal
      if (modal?.classList.contains('open')) {
        const url = new URL(window.location.href);
        const status = url.searchParams.get('status');
        window.location.href = '/admin/requests' + (status ? `?status=${status}` : '');
      }
      // Close dropdown
      closeDropdown();
    }
  });

  // Custom dropdown handler
  const dropdownTrigger = document.getElementById('dropdownTrigger');
  const dropdownMenu = document.getElementById('dropdownMenu');

  function openDropdown() {
    dropdownTrigger?.classList.add('open');
    dropdownMenu?.classList.add('open');
  }

  function closeDropdown() {
    dropdownTrigger?.classList.remove('open');
    dropdownMenu?.classList.remove('open');
  }

  function toggleDropdown() {
    if (dropdownMenu?.classList.contains('open')) {
      closeDropdown();
    } else {
      openDropdown();
    }
  }

  dropdownTrigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleDropdown();
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('statusDropdown');
    if (!dropdown?.contains(e.target as Node)) {
      closeDropdown();
    }
  });
</script>
