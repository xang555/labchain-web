---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getAllBeaconNodes, getBeaconNodeById, createBeaconNode, updateBeaconNode, deleteBeaconNode } from '../../lib/data';
import { validateSessionCookie } from '../../lib/auth';

// Check authentication
const user = validateSessionCookie(Astro.request.headers.get('cookie') ?? undefined);
if (!user) {
  return Astro.redirect('/admin/login');
}

let message = '';
let messageType = '';

// Handle form submissions
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action')?.toString();

  if (action === 'create' || action === 'update') {
    const data = {
      name: formData.get('name')?.toString() || '',
      endpoint: formData.get('endpoint')?.toString() || '',
      location: formData.get('location')?.toString() || '',
      status: (formData.get('status')?.toString() || 'active') as 'active' | 'syncing' | 'inactive',
      version: formData.get('version')?.toString() || '',
      sync_status: formData.get('sync_status')?.toString() || '',
      slots: formData.get('slots')?.toString() || '',
      epoch: formData.get('epoch')?.toString() || '',
      last_update: formData.get('last_update')?.toString() || '',
    };

    if (action === 'create') {
      createBeaconNode(data);
      message = 'Beacon node created successfully';
      messageType = 'success';
    } else {
      const id = parseInt(formData.get('id')?.toString() || '0');
      updateBeaconNode(id, data);
      message = 'Beacon node updated successfully';
      messageType = 'success';
    }
  } else if (action === 'delete') {
    const id = parseInt(formData.get('id')?.toString() || '0');
    deleteBeaconNode(id);
    message = 'Beacon node deleted successfully';
    messageType = 'success';
  }
}

const beaconNodes = getAllBeaconNodes();
const urlParams = new URL(Astro.request.url).searchParams;
const showModal = urlParams.get('action') === 'new' || urlParams.get('edit');
const editId = urlParams.get('edit') ? parseInt(urlParams.get('edit')!) : null;
const editItem = editId ? getBeaconNodeById(editId) : null;
---

<AdminLayout title="Beacon Nodes" currentPage="beacon" user={user}>
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1 class="page-title">Beacon Nodes</h1>
        <p class="page-subtitle">Manage consensus layer beacon nodes for LAB Chain</p>
      </div>
      <a href="/admin/beacon-nodes?action=new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add Beacon Node
      </a>
    </div>
  </div>

  {message && (
    <div class={`alert alert-${messageType}`}>{message}</div>
  )}

  <div class="card">
    {beaconNodes.length === 0 ? (
      <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
          <polyline points="2 17 12 22 22 17"></polyline>
          <polyline points="2 12 12 17 22 12"></polyline>
        </svg>
        <h3>No Beacon Nodes</h3>
        <p>Add your first beacon node to get started.</p>
        <a href="/admin/beacon-nodes?action=new" class="btn btn-primary">Add Beacon Node</a>
      </div>
    ) : (
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Endpoint</th>
              <th>Location</th>
              <th>Version</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {beaconNodes.map((node) => (
              <tr>
                <td>
                  <strong>{node.name}</strong>
                </td>
                <td>
                  <code class="endpoint-code">{node.endpoint}</code>
                </td>
                <td>{node.location || '-'}</td>
                <td>{node.version || '-'}</td>
                <td>
                  <span class={`status-badge ${node.status}`}>{node.status}</span>
                </td>
                <td>
                  <div class="actions-cell">
                    <a href={`/admin/beacon-nodes?edit=${node.id}`} class="action-icon" title="Edit">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </a>
                    <form method="POST" class="inline-form" onsubmit="return confirm('Are you sure you want to delete this beacon node?')">
                      <input type="hidden" name="action" value="delete" />
                      <input type="hidden" name="id" value={node.id} />
                      <button type="submit" class="action-icon delete" title="Delete">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    )}
  </div>

  <!-- Modal -->
  <div class={`modal-overlay ${showModal ? 'open' : ''}`} id="modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">{editItem ? 'Edit Beacon Node' : 'Add Beacon Node'}</h2>
        <a href="/admin/beacon-nodes" class="modal-close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </a>
      </div>
      <form method="POST">
        <div class="modal-body">
          <input type="hidden" name="action" value={editItem ? 'update' : 'create'} />
          {editItem && <input type="hidden" name="id" value={editItem.id} />}

          <div class="form-group">
            <label class="form-label">Name *</label>
            <input type="text" name="name" class="form-input" required value={editItem?.name || ''} placeholder="e.g., LAB Chain Beacon Node 1" />
          </div>

          <div class="form-group">
            <label class="form-label">Endpoint URL *</label>
            <input type="url" name="endpoint" class="form-input" required value={editItem?.endpoint || ''} placeholder="https://beacon1.labchain.la" />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Location</label>
              <input type="text" name="location" class="form-input" value={editItem?.location || ''} placeholder="e.g., Vientiane, Laos" />
            </div>

            <div class="form-group">
              <label class="form-label">Status</label>
              <select name="status" class="form-select">
                <option value="active" selected={editItem?.status === 'active' || !editItem}>Active</option>
                <option value="syncing" selected={editItem?.status === 'syncing'}>Syncing</option>
                <option value="inactive" selected={editItem?.status === 'inactive'}>Inactive</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Version</label>
              <input type="text" name="version" class="form-input" value={editItem?.version || ''} placeholder="e.g., v4.1.0" />
            </div>

            <div class="form-group">
              <label class="form-label">Sync Status</label>
              <input type="text" name="sync_status" class="form-input" value={editItem?.sync_status || ''} placeholder="e.g., Synced" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Slots</label>
              <input type="text" name="slots" class="form-input" value={editItem?.slots || ''} placeholder="e.g., 1,234,567" />
            </div>

            <div class="form-group">
              <label class="form-label">Epoch</label>
              <input type="text" name="epoch" class="form-input" value={editItem?.epoch || ''} placeholder="e.g., 38,580" />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Last Update</label>
            <input type="text" name="last_update" class="form-input" value={editItem?.last_update || ''} placeholder="e.g., 12 seconds ago" />
          </div>
        </div>
        <div class="modal-footer">
          <a href="/admin/beacon-nodes" class="btn btn-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">{editItem ? 'Update' : 'Create'}</button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<style>
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .endpoint-code {
    font-size: 12px;
    background: var(--bg-tertiary);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
  }

  .inline-form {
    display: inline;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  @media (max-width: 640px) {
    .header-content {
      flex-direction: column;
      gap: 16px;
    }

    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const modal = document.getElementById('modal');
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      window.location.href = '/admin/beacon-nodes';
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('open')) {
      window.location.href = '/admin/beacon-nodes';
    }
  });
</script>
