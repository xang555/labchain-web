---
import AdminLayout from '../../layouts/AdminLayout.astro';
import Pagination from '../../components/Pagination.astro';
import { getBeaconNodesPaginated, getBeaconNodeById, createBeaconNode, updateBeaconNode, deleteBeaconNode } from '../../lib/data';
import { validateSessionCookie } from '../../lib/auth';

// Check authentication
const user = validateSessionCookie(Astro.request.headers.get('cookie') ?? undefined);
if (!user) {
  return Astro.redirect('/admin/login');
}

// Handle success messages from redirects
const urlParamsMsg = new URL(Astro.request.url).searchParams;
const successParam = urlParamsMsg.get('success');
let message = '';
let messageType = '';

const errorParam = urlParamsMsg.get('error');

if (successParam === 'created') {
  message = 'Beacon node created successfully';
  messageType = 'success';
} else if (successParam === 'updated') {
  message = 'Beacon node updated successfully';
  messageType = 'success';
} else if (successParam === 'deleted') {
  message = 'Beacon node deleted successfully';
  messageType = 'success';
} else if (errorParam) {
  message = errorParam;
  messageType = 'error';
}

// Handle form submissions
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action')?.toString();

  if (action === 'create' || action === 'update') {
    const name = formData.get('name')?.toString() || '';
    const enr = formData.get('enr')?.toString() || '';
    const p2p = formData.get('p2p')?.toString() || '';

    // Validate: at least one of ENR or P2P must be provided
    if (!enr && !p2p) {
      return Astro.redirect('/admin/beacon-nodes?error=At least one of ENR or P2P must be provided');
    }

    const data = { name, enr, p2p };

    if (action === 'create') {
      createBeaconNode(data);
      return Astro.redirect('/admin/beacon-nodes?success=created');
    } else {
      const id = parseInt(formData.get('id')?.toString() || '0');
      updateBeaconNode(id, data);
      return Astro.redirect('/admin/beacon-nodes?success=updated');
    }
  } else if (action === 'delete') {
    const id = parseInt(formData.get('id')?.toString() || '0');
    deleteBeaconNode(id);
    return Astro.redirect('/admin/beacon-nodes?success=deleted');
  }
}

// Pagination
const urlParams = new URL(Astro.request.url).searchParams;
const currentPage = Math.max(1, parseInt(urlParams.get('page') || '1'));
const limit = 10;

const { data: beaconNodes, total, totalPages } = getBeaconNodesPaginated(currentPage, limit);

const showModal = urlParams.get('action') === 'new' || urlParams.get('edit');
const editId = urlParams.get('edit') ? parseInt(urlParams.get('edit')!) : null;
const editItem = editId ? getBeaconNodeById(editId) : null;
---

<AdminLayout title="Beacon Nodes" currentPage="beacon" user={user}>
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1 class="page-title">Beacon Nodes</h1>
        <p class="page-subtitle">Manage consensus layer beacon nodes for LAB Chain</p>
      </div>
      <a href="/admin/beacon-nodes?action=new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add Beacon Node
      </a>
    </div>
  </div>

  {message && (
    <div class={`alert alert-${messageType}`}>{message}</div>
  )}

  <div class="card">
    {beaconNodes.length === 0 ? (
      <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
          <polyline points="2 17 12 22 22 17"></polyline>
          <polyline points="2 12 12 17 22 12"></polyline>
        </svg>
        <h3>No Beacon Nodes</h3>
        <p>Add your first beacon node to get started.</p>
        <a href="/admin/beacon-nodes?action=new" class="btn btn-primary">Add Beacon Node</a>
      </div>
    ) : (
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>ENR</th>
              <th>P2P (libp2p)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {beaconNodes.map((node) => (
              <tr>
                <td>
                  <strong>{node.name}</strong>
                </td>
                <td>
                  <code class="endpoint-code">{node.enr ? (node.enr.length > 40 ? node.enr.substring(0, 40) + '...' : node.enr) : '-'}</code>
                </td>
                <td>
                  <code class="endpoint-code">{node.p2p ? (node.p2p.length > 40 ? node.p2p.substring(0, 40) + '...' : node.p2p) : '-'}</code>
                </td>
                <td>
                  <div class="actions-cell">
                    <a href={`/admin/beacon-nodes?edit=${node.id}`} class="action-icon" title="Edit">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </a>
                    <form method="POST" class="inline-form" onsubmit="return confirm('Are you sure you want to delete this beacon node?')">
                      <input type="hidden" name="action" value="delete" />
                      <input type="hidden" name="id" value={node.id} />
                      <button type="submit" class="action-icon delete" title="Delete">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        <Pagination
          currentPage={currentPage}
          totalPages={totalPages}
          total={total}
          baseUrl="/admin/beacon-nodes"
        />
      </div>
    )}
  </div>

  <!-- Modal -->
  <div class={`modal-overlay ${showModal ? 'open' : ''}`} id="modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">{editItem ? 'Edit Beacon Node' : 'Add Beacon Node'}</h2>
        <a href="/admin/beacon-nodes" class="modal-close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </a>
      </div>
      <form method="POST">
        <div class="modal-body">
          <input type="hidden" name="action" value={editItem ? 'update' : 'create'} />
          {editItem && <input type="hidden" name="id" value={editItem.id} />}

          <div class="form-group">
            <label class="form-label">Name *</label>
            <input type="text" name="name" class="form-input" required value={editItem?.name || ''} placeholder="e.g., LAB Chain Beacon Node 1" />
          </div>

          <div class="form-group">
            <label class="form-label">ENR (Ethereum Node Record)</label>
            <textarea name="enr" class="form-textarea" placeholder="enr:-...">{editItem?.enr || ''}</textarea>
            <span class="form-hint">The ENR string for peer discovery</span>
          </div>

          <div class="form-group">
            <label class="form-label">P2P (libp2p Address)</label>
            <textarea name="p2p" class="form-textarea" placeholder="/ip4/...or /dns4/...">{editItem?.p2p || ''}</textarea>
            <span class="form-hint">The libp2p multiaddress for direct P2P connection</span>
          </div>
        </div>
        <div class="modal-footer">
          <a href="/admin/beacon-nodes" class="btn btn-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">{editItem ? 'Update' : 'Create'}</button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<style>
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .endpoint-code {
    font-size: 12px;
    background: var(--bg-tertiary);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
  }

  .inline-form {
    display: inline;
  }

  .form-hint {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    color: var(--text-tertiary);
  }

  @media (max-width: 640px) {
    .header-content {
      flex-direction: column;
      gap: 16px;
    }
  }
</style>

<script>
  const modal = document.getElementById('modal');
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      window.location.href = '/admin/beacon-nodes';
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('open')) {
      window.location.href = '/admin/beacon-nodes';
    }
  });
</script>
