---
import AdminLayout from '../../layouts/AdminLayout.astro';
import Pagination from '../../components/Pagination.astro';
import { getRpcEndpointsPaginated, getRpcEndpointById, createRpcEndpoint, updateRpcEndpoint, deleteRpcEndpoint } from '../../lib/data';
import { validateSessionCookie } from '../../lib/auth';

// Check authentication
const user = validateSessionCookie(Astro.request.headers.get('cookie') ?? undefined);
if (!user) {
  return Astro.redirect('/admin/login');
}

// Handle success messages from redirects
const urlParamsMsg = new URL(Astro.request.url).searchParams;
const successParam = urlParamsMsg.get('success');
let message = '';
let messageType = '';

if (successParam === 'created') {
  message = 'RPC endpoint created successfully';
  messageType = 'success';
} else if (successParam === 'updated') {
  message = 'RPC endpoint updated successfully';
  messageType = 'success';
} else if (successParam === 'deleted') {
  message = 'RPC endpoint deleted successfully';
  messageType = 'success';
}

// Handle form submissions
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action')?.toString();

  if (action === 'create' || action === 'update') {
    const data = {
      name: formData.get('name')?.toString() || '',
      endpoint: formData.get('endpoint')?.toString() || '',
      type: (formData.get('type')?.toString() || 'community') as 'official' | 'community',
    };

    if (action === 'create') {
      createRpcEndpoint(data);
      return Astro.redirect('/admin/rpc?success=created');
    } else {
      const id = parseInt(formData.get('id')?.toString() || '0');
      updateRpcEndpoint(id, data);
      return Astro.redirect('/admin/rpc?success=updated');
    }
  } else if (action === 'delete') {
    const id = parseInt(formData.get('id')?.toString() || '0');
    deleteRpcEndpoint(id);
    return Astro.redirect('/admin/rpc?success=deleted');
  }
}

// Pagination
const urlParams = new URL(Astro.request.url).searchParams;
const currentPage = Math.max(1, parseInt(urlParams.get('page') || '1'));
const limit = 10;

const { data: rpcEndpoints, total, totalPages } = getRpcEndpointsPaginated(currentPage, limit);

const showModal = urlParams.get('action') === 'new' || urlParams.get('edit');
const editId = urlParams.get('edit') ? parseInt(urlParams.get('edit')!) : null;
const editItem = editId ? getRpcEndpointById(editId) : null;
---

<AdminLayout title="RPC Endpoints" currentPage="rpc" user={user}>
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1 class="page-title">RPC Endpoints</h1>
        <p class="page-subtitle">Manage public RPC endpoints for LAB Chain</p>
      </div>
      <a href="/admin/rpc?action=new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add Endpoint
      </a>
    </div>
  </div>

  {message && (
    <div class={`alert alert-${messageType}`}>{message}</div>
  )}

  <div class="card">
    {rpcEndpoints.length === 0 ? (
      <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        </svg>
        <h3>No RPC Endpoints</h3>
        <p>Add your first RPC endpoint to get started.</p>
        <a href="/admin/rpc?action=new" class="btn btn-primary">Add Endpoint</a>
      </div>
    ) : (
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Endpoint</th>
              <th>Type</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {rpcEndpoints.map((rpc) => (
              <tr>
                <td>
                  <strong>{rpc.name}</strong>
                </td>
                <td>
                  <code class="endpoint-code">{rpc.endpoint}</code>
                </td>
                <td>
                  <span class={`type-badge ${rpc.type}`}>{rpc.type}</span>
                </td>
                <td>
                  <div class="actions-cell">
                    <a href={`/admin/rpc?edit=${rpc.id}`} class="action-icon" title="Edit">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </a>
                    <form method="POST" class="inline-form" onsubmit="return confirm('Are you sure you want to delete this endpoint?')">
                      <input type="hidden" name="action" value="delete" />
                      <input type="hidden" name="id" value={rpc.id} />
                      <button type="submit" class="action-icon delete" title="Delete">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        <Pagination
          currentPage={currentPage}
          totalPages={totalPages}
          total={total}
          baseUrl="/admin/rpc"
        />
      </div>
    )}
  </div>

  <!-- Modal -->
  <div class={`modal-overlay ${showModal ? 'open' : ''}`} id="modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">{editItem ? 'Edit RPC Endpoint' : 'Add RPC Endpoint'}</h2>
        <a href="/admin/rpc" class="modal-close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </a>
      </div>
      <form method="POST">
        <div class="modal-body">
          <input type="hidden" name="action" value={editItem ? 'update' : 'create'} />
          {editItem && <input type="hidden" name="id" value={editItem.id} />}

          <div class="form-group">
            <label class="form-label">Name *</label>
            <input type="text" name="name" class="form-input" required value={editItem?.name || ''} placeholder="e.g., LAB Chain Official RPC" />
          </div>

          <div class="form-group">
            <label class="form-label">Endpoint URL *</label>
            <input type="url" name="endpoint" class="form-input" required value={editItem?.endpoint || ''} placeholder="https://rpc.labchain.la" />
          </div>

          <div class="form-group">
            <label class="form-label">Type</label>
            <select name="type" class="form-select">
              <option value="official" selected={editItem?.type === 'official'}>Official</option>
              <option value="community" selected={editItem?.type === 'community' || !editItem}>Community</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <a href="/admin/rpc" class="btn btn-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">{editItem ? 'Update' : 'Create'}</button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<style>
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .endpoint-code {
    font-size: 12px;
    background: var(--bg-tertiary);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
  }

  .inline-form {
    display: inline;
  }

  @media (max-width: 640px) {
    .header-content {
      flex-direction: column;
      gap: 16px;
    }
  }
</style>

<script>
  // Close modal on overlay click
  const modal = document.getElementById('modal');
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      window.location.href = '/admin/rpc';
    }
  });

  // Close modal on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('open')) {
      window.location.href = '/admin/rpc';
    }
  });
</script>
