---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getAllBootNodes, getBootNodeById, createBootNode, updateBootNode, deleteBootNode } from '../../lib/data';
import { validateSessionCookie } from '../../lib/auth';

// Check authentication
const user = validateSessionCookie(Astro.request.headers.get('cookie') ?? undefined);
if (!user) {
  return Astro.redirect('/admin/login');
}

// Handle success messages from redirects
const urlParamsMsg = new URL(Astro.request.url).searchParams;
const successParam = urlParamsMsg.get('success');
let message = '';
let messageType = '';

if (successParam === 'created') {
  message = 'Boot node created successfully';
  messageType = 'success';
} else if (successParam === 'updated') {
  message = 'Boot node updated successfully';
  messageType = 'success';
} else if (successParam === 'deleted') {
  message = 'Boot node deleted successfully';
  messageType = 'success';
}

// Handle form submissions
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action')?.toString();

  if (action === 'create' || action === 'update') {
    const data = {
      name: formData.get('name')?.toString() || '',
      enode: formData.get('enode')?.toString() || '',
    };

    if (action === 'create') {
      createBootNode(data);
      return Astro.redirect('/admin/boot-nodes?success=created');
    } else {
      const id = parseInt(formData.get('id')?.toString() || '0');
      updateBootNode(id, data);
      return Astro.redirect('/admin/boot-nodes?success=updated');
    }
  } else if (action === 'delete') {
    const id = parseInt(formData.get('id')?.toString() || '0');
    deleteBootNode(id);
    return Astro.redirect('/admin/boot-nodes?success=deleted');
  }
}

const bootNodes = getAllBootNodes();
const urlParams = new URL(Astro.request.url).searchParams;
const showModal = urlParams.get('action') === 'new' || urlParams.get('edit');
const editId = urlParams.get('edit') ? parseInt(urlParams.get('edit')!) : null;
const editItem = editId ? getBootNodeById(editId) : null;
---

<AdminLayout title="Boot Nodes" currentPage="boot" user={user}>
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1 class="page-title">Boot Nodes</h1>
        <p class="page-subtitle">Manage execution layer boot nodes for LAB Chain</p>
      </div>
      <a href="/admin/boot-nodes?action=new" class="btn btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add Boot Node
      </a>
    </div>
  </div>

  {message && (
    <div class={`alert alert-${messageType}`}>{message}</div>
  )}

  <div class="card">
    {bootNodes.length === 0 ? (
      <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
          <line x1="8" y1="21" x2="16" y2="21"></line>
          <line x1="12" y1="17" x2="12" y2="21"></line>
        </svg>
        <h3>No Boot Nodes</h3>
        <p>Add your first boot node to get started.</p>
        <a href="/admin/boot-nodes?action=new" class="btn btn-primary">Add Boot Node</a>
      </div>
    ) : (
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Enode URL</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {bootNodes.map((node) => (
              <tr>
                <td>
                  <strong>{node.name}</strong>
                </td>
                <td>
                  <code class="endpoint-code">{node.enode.length > 60 ? node.enode.substring(0, 60) + '...' : node.enode}</code>
                </td>
                <td>
                  <div class="actions-cell">
                    <a href={`/admin/boot-nodes?edit=${node.id}`} class="action-icon" title="Edit">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </a>
                    <form method="POST" class="inline-form" onsubmit="return confirm('Are you sure you want to delete this boot node?')">
                      <input type="hidden" name="action" value="delete" />
                      <input type="hidden" name="id" value={node.id} />
                      <button type="submit" class="action-icon delete" title="Delete">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    )}
  </div>

  <!-- Modal -->
  <div class={`modal-overlay ${showModal ? 'open' : ''}`} id="modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">{editItem ? 'Edit Boot Node' : 'Add Boot Node'}</h2>
        <a href="/admin/boot-nodes" class="modal-close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </a>
      </div>
      <form method="POST">
        <div class="modal-body">
          <input type="hidden" name="action" value={editItem ? 'update' : 'create'} />
          {editItem && <input type="hidden" name="id" value={editItem.id} />}

          <div class="form-group">
            <label class="form-label">Name *</label>
            <input type="text" name="name" class="form-input" required value={editItem?.name || ''} placeholder="e.g., LAB Chain Boot Node 1" />
          </div>

          <div class="form-group">
            <label class="form-label">Enode URL *</label>
            <textarea name="enode" class="form-textarea" required placeholder="enode://abc123...@boot1.labchain.la:30303">{editItem?.enode || ''}</textarea>
            <span class="form-hint">The full enode URL including public key, IP address, and port</span>
          </div>
        </div>
        <div class="modal-footer">
          <a href="/admin/boot-nodes" class="btn btn-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">{editItem ? 'Update' : 'Create'}</button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<style>
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .endpoint-code {
    font-size: 12px;
    background: var(--bg-tertiary);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
  }

  .inline-form {
    display: inline;
  }

  .form-hint {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    color: var(--text-tertiary);
  }

  @media (max-width: 640px) {
    .header-content {
      flex-direction: column;
      gap: 16px;
    }
  }
</style>

<script>
  const modal = document.getElementById('modal');
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      window.location.href = '/admin/boot-nodes';
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('open')) {
      window.location.href = '/admin/boot-nodes';
    }
  });
</script>
